## Workflow to create a checkout against API v3 with PHP and Guzzle

### Preparation

#### Install Guzzle

First of all you need to install Guzzle. Please follow the steps [here](http://docs.guzzlephp.org/en/stable/overview.html#installation)

#### Create API-Token

We will use our all new RESTfull [API](https://api.plenigo.com/doc/v3/). To authorize against this API, one have to create an API-Access-Token.
You will need settings section in plenigo-Backend  and at least the right to write Settings, to create a new Access-Token.


#### Examples for external User-Management

At the moment we only provide examples for external customer management. 

#### Initialize Guzzle

```php
$client = new GuzzleHttp\Client(['base_uri' => 'https://api.plenigo.com/api/v3.0/']);
```

#### POST the Customer

We tried to keep the examples as simple as possible. You can [pimp the guzzle client as much as you want](http://docs.guzzlephp.org/en/stable/request-options.html#json) .

```php
$client = new GuzzleHttp\Client(['base_uri' => 'https://api.plenigo.com/api/v3.0/']);
$user = [
    'customerId' => "4711", // User-ID in external system
    'email' => "{$emailAdress}", // E-Mail address of your customer
    'language' => 'de',
  ];

$response = $client->request('POST', 'customers', [
    // here you will need to work with the Api-Access token from plenigo backend
    'headers' => ['X-plenigo-token' => 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0aGVzZSI6ImFyZSIsInBsZW5pZ28iOiJ0ZXN0IiwiZGF0YSI6ImRvIiwibm90IjoiY29uc3VtZSJ9.xnFAQQbHEFLisgeU2YqWsIfpCgEbmh_Hy59Ja0Ztxyw'],
    // the payload, we'll send
    'json' => $user
]);

$customer = json_decode($response->getBody()->getContents());

```

This will return the created user or the already existing user. It will not recreate it.

#### Create Checkout-Code

After having a customer we need to create a checkout token:

```php
// @see https://stackoverflow.com/a/55790/2336470
if (!empty($_SERVER['HTTP_CLIENT_IP'])) {
    $ip = $_SERVER['HTTP_CLIENT_IP'];
} elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
    $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
} else {
    $ip = $_SERVER['REMOTE_ADDR'];
}

$payload = [
    "debugMode" => true, // enable debugging in checkout (please turn it off in prod environment)
    "customerIpAddress" => $ip,
    "customerId" => $customer['customerId'],
    "items" => [
        [
            "plenigoOfferId" => "O_6E487EBURRY35FOD0J", // Macbeth
            "quantity" => 1,
        ],
    ],
    "additionalData" => [
        "data" => [
            'foo' => 'bar' // additional data are set in the order and can be used for further processing
        ]
    ]
]);

$response = $client->request('POST', '/checkout/preparePurchase', [
      'headers' => ['X-plenigo-token' => 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0aGVzZSI6ImFyZSIsInBsZW5pZ28iOiJ0ZXN0IiwiZGF0YSI6ImRvIiwibm90IjoiY29uc3VtZSJ9.xnFAQQbHEFLisgeU2YqWsIfpCgEbmh_Hy59Ja0Ztxyw'],
      'json' => $payload
]);



Next you will need to get 

```php
<?php
//2. Request an access token
//This object is used to request the token, you specificy the customer id, the product and the description
$appAccessToken = AppManagementService::requestAppToken("customerId", "productId", "Tablet Access");
//3. Request a customer application access with the AppTokenData object
//Once you have the access token, you can use this to request a customer application id for the third party
$appAccessData = AppManagementService::requestAppId($appAccessToken->getCustomerId(), $appAccessToken->getAppToken());
```

***
Once you have the application access data, you can give this information to the third party and they can reuse this as many times as they would like.
***

***
There is a limit of how many customer application ids you can request, but you can configure that in the company management interface of plenigo.
***

### Sample usage of customer application id for third parties(companies and third parties can do this)

As a third party, once we have all the information provided above, we can query information, a code sample of how to do this is provided below:

***
You must configure the plenigo manager once before doing any sdk method call, but we configure it in this example in order to clarify where to put the application id provided by the company.

Also companies can use their own secret instead of the application id to call this method.
***

```php
<?php
//With the customer application id you can query product information, in the example below, we are requesting to see
//if an user has bought a product.
//This returns a boolean that will tell you if the user did buy the product(true) or not(false).
$hasUserBought = AppManagementService::hasUserBought("customerId", "productId", "customerAppId");
```
### Query customer application ids(companies and third parties can do this)

As a company or a third party, you can request the current applications that you have registered for a specific customer(As a third party, you must configure the application id in the plenigo manager to do this, for more information see the "Sample usage of customer application id for third parties" in this wiki).

In order to do this, you can use the `\plenigo\services\AppManagement#getCustomerApps` method, an example is provided below:

```php
<?php
//This method will return a list of customer application access information
$appsData = AppManagementService::getCustomerApps("customerId");
```

### Remove an application id for a customer(only companies can do this)

As a company, if you would like to remove a customer application id, you can do this with the Application management service.

In order to do this, you must use the `\plenigo\services\AppManagement#deleteCustomerApp` method, an example is provided below:

```php
<?php
//As long as this method does not return an exception, this will delete the customer app id for the specific //customer
AppManagementService::deleteCustomerApp("customerId", "customerAppId");
```
